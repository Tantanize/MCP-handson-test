# 映画館窓口業務エージェント - 要件定義書

## 1. 概要
映画館の窓口業務を行うエージェントを実現するため、MCPツール群を実装する。
業務内容は以下の流れで構成される：
- 映画・上映時間の確定
- 空席情報の提示と座席選択
- 予約確定

## 2. 機能要件

### 2.1 映画情報管理機能
**機能名**: get_movie_list
**説明**: 現在上映中の映画一覧を取得する
**要件**:
- 映画名、上映時間、ジャンル、評価、概要等の基本情報を管理
- 日付指定による絞り込み機能
- 映画の推薦機能（評価・ジャンル・人気度に基づく）

### 2.2 上映スケジュール管理機能
**機能名**: get_show_schedule
**説明**: 指定した映画の上映スケジュールを取得する
**要件**:
- 映画名および日付を指定して上映時間一覧を取得
- 各上映時間枠の上映館ID、空席有無も併せて取得

### 2.3 人気度算出機能
**機能名**: get_movie_popularity
**説明**: 上映している映画の人気度を上映スケジュールより計算する
**要件**:
- 上映スケジュールと各時間帯の座席状況を取得
- 各映画について、取得した座席状況をもとに現在すでに予約されている座席の総数（入場者数）を算出
- 入場者数の多い順に上映中のすべての映画の人気度ランキングを作成

### 2.4 座席空き状況取得機能
**機能名**: get_seat_availability
**説明**: 指定した上映回の座席空き状況を取得する
**要件**:
- 上映スケジュールIDを指定して当該上映館IDの座席状況を取得
- 空いている座席の一覧返却

### 2.5 座席予約機能
**機能名**: reserve_seats
**説明**: 指定した座席の予約を実行する
**要件**:
- 映画名、日付、上映時間、座席番号を指定して予約確定
- 複数座席の同時予約対応
- 予約確定の時、予約PWを指定
- 予約PWのハッシュ値を保存し、予約IDを生成して返却

### 2.6 予約確認機能
**機能名**: get_reservation_details
**説明**: 確定した予約の詳細情報を取得する
**要件**:
- 予約ID、映画名、日時、座席番号等の予約詳細表示
- 予約IDと予約PWによる検索機能

## 3. データ構造要件

### 3.1 映画データ
- movie_id: 映画ID（主キー）
- title: 映画名
- genre: ジャンル
- duration: 上映時間（分）
- rating: 評価（1-5）
- description: 概要
- release_date: 公開日

### 3.2 上映スケジュールデータ
- schedule_id: スケジュールID（主キー）
- movie_id: 映画ID
- date: 上映日
- start_time: 開始時間
- end_time: 終了時間
- theater_id: 上映館ID

### 3.3 上映回座席状況データ
- schedule_id: スケジュールID（主キー、上映スケジュールデータと関連する外部キー）
- overall_seats: 席総数のリスト
  - seat_id: 座席ID（（"A1", "A2", "B1"等の形式）
  - row: 行（A, B, C...）
  - column: 列（1, 2, 3...）
- available_seats: 予約済み座席リスト（overall_seatsと同じ構造）

### 3.4 予約データ
- reservation_id: 予約ID（主キー）
- reservation_pw_hash: 予約PWのハッシュ値
- schedule_id: スケジュールID
- reservation_seats: 予約座席リスト（overall_seatsと同じ構造）
- reservation_time: 予約確定時刻
- status: 予約状況（確定、キャンセル等）

### 3.5 人気度データ
- movie_id: 映画ID（主キー、映画データと関連する外部キー）
- title: 映画名
- popularity: 入場者総数
- popularity_rank: 人気度ランキング

## 4. 非機能要件

- 可用性: サービス稼働率は99.5%以上を目標とする。
- 性能: 単一APIリクエストの応答時間は通常条件で500ms以内、ピーク時でも2秒以内を目安とする。
- 同時処理: 同時リクエスト数の目安は1000TPSを想定し、スケール可能な設計とする。
- データ整合性: 座席予約は競合制御（楽観ロックまたはトランザクション）を用いて二重予約を防止する。
- セキュリティ: すべての外部APIはHTTPSを利用し、予約PWはハッシュ化して保存する。個人情報は最小限に留め、必要に応じて暗号化する。
- 保守性: ロギング、メトリクス、トレースを備え、障害時に原因追跡ができること。
- データ保持: 予約データは運用ポリシーに従い保持期間を定める（例: 1年）。

## 5. エラーハンドリングと入力検証

- 入力検証: 映画ID・スケジュールID・座席IDの形式検証を必須とする。
- 競合エラー: 座席が確保済みの場合はHTTP 409（Conflict）等で明示し、ユーザーに再選択を促す。
- 存在しないリソース: 404を返却。
- バリデーションエラー: 400を返却し、フィールド単位のエラーメッセージを含める。

## 6. セキュリティ・プライバシー

- 通信: 全トラフィックはTLS(HTTPS)で保護。
- 認証: 管理系APIは認証（OAuth2/OpenID Connect等）を必須とする。公開読み取りAPIは必要最小限の認証で運用可能。
- 予約PW: ハッシュ化（bcrypt/scrypt/argon2等）で保存し、復号不可とする。
- ログ: ログに生の予約PWや個人識別情報を出力しない。

## 7. テスト・受け入れ基準

- ユニットテスト: 各機能（座席選定、予約生成、ハッシュ化ロジック）を網羅
- 結合テスト: スケジュール取得→座席取得→予約の一連フローを自動化
- 負荷テスト: 同時予約シナリオで競合回避と性能を確認
- 受け入れ基準: 下記を満たすこと
  - 映画一覧取得が正常に動作すること
  - 指定上映回の空席取得が正しいこと
  - 同一座席の二重予約が発生しないこと（競合時409を返す）

## 8. 前提・制約

- 本要件では決済処理は対象外とする（別途統合予定）
- ユーザー認証は最小限とし、匿名予約を許容する仕様も可能
- 外部映画データの同期方法（手動/自動）は実装フェーズで確定する

---
改訂: 要件に非機能・運用・テスト項目を追加し、座席データ構造とAPIフローを明確化しました。